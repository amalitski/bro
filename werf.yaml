{{ $_ := set . "TZDATA_VERSION" "2021a-3" }}

project: bro
configVersion: 1
---
artifact: build
from: maven:3.8-openjdk-16
git:
  - add: /
    to: /app
    excludePaths:
      - .gitlab-ci.yml
      - .helm
      - werf.yaml
    stageDependencies:
      install:
      - 'src/**/*'
      - 'pom.xml'
ansible:
  beforeInstall:
  - name: Download tzdata.deb
    get_url:
      url: https://gitlab.timebook.cloud/api/v4/projects/216/jobs/artifacts/{{ .TZDATA_VERSION }}/raw/tzdata_{{ .TZDATA_VERSION }}_all.deb?job=build
      dest: /var/tzdata.deb
      mode: '0444'
      headers:
        PRIVATE-TOKEN: "aZxpvxaA_QVdGB6wRRAQ"
  - name: Install tzdata
    shell: |
      dpkg -i /var/tzdata.deb
shell:
  install:
    - cd /app
    - export JAVA_OPTS="-Dhttps.protocols=TLSv1.2"
    - export MAVEN_OPTS="-Dhttps.protocols=TLSv1.2"
    - mvn -U clean package
---
image: bro
from: maven:3.8-openjdk-16
import:
  - artifact: build
    after: install
    add: /app/target/bro.jar
    to: /app/bro.jar
docker:
  WORKDIR: /app
shell:
  install:
    - mkdir /app
